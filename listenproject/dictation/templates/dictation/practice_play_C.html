<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å£è¯´å›ç­”æ¨¡å¼</title>
</head>
<body onload="checkMicrophoneAvailability()">
<h1>ğŸ¤ å£è¯´å›ç­”æ¨¡å¼</h1>
<a href="{% url 'practice_setting' %}?checkmic=1">ğŸ¤ éº¦å…‹é£æ£€æµ‹ä¸å£è¿°ç»ƒä¹ </a>
<p id="timer" style="font-weight: bold; color: green;"></p>

<div id="question-area">
    <p><strong id="question-text">å‡†å¤‡ä¸­...</strong></p>
    <audio id="question-audio" controls style="display: none;"></audio>
</div>

<div id="recording-area" style="margin-top: 20px;">
    <button id="record-btn" onclick="startRecording()">ğŸ§ å¼€å§‹å½•éŸ³</button>
    <button id="stop-btn" onclick="stopRecording()" disabled>â¹ åœæ­¢å½•éŸ³</button>
    <button onclick="startTranscription()">ğŸ™ï¸ è½¬æ–‡å­—</button>
    <p id="transcript"></p>

</div>

<div id="audio-preview-area" style="margin-top: 20px;"></div>
<audio id="question-audio" controls style="display:none;"></audio>

<script>
    const materials = {{ materials|safe }};
    shuffle(materials);
    
    let currentIndex = 0;
    let answers = [];
    
    const questionTextEl = document.getElementById('question-text');
    const questionAudioEl = document.getElementById('question-audio');
    const timerEl = document.getElementById('timer');
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const previewArea = document.getElementById('audio-preview-area');
    
    let mediaRecorder;
    let audioChunks = [];
    
    function checkMicrophoneAvailability() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("âŒ æ­¤æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³ï¼Œè¯·æ›´æ¢ç¯å¢ƒ");
            return;
        }
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => stream.getTracks().forEach(track => track.stop()))
            .catch(err => alert("è¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£"));
    }
    
    async function startRecording() {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
    
        recordBtn.disabled = true;
        stopBtn.disabled = false;
    
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    
        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const base64 = await blobToBase64(blob);
    
            const material = materials[currentIndex - 1];
            const materialId = material.id;
    
            const recognizedText = await transcribeBlob(blob);
    
            answers.push({
                material_id: materialId,
                audio_data: base64,
                user_input: recognizedText
            });
    
            // å‘é€åç«¯ä¿å­˜
            fetch("{% url 'api_save_answer' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    material_id: materialId,
                    recognized_text: recognizedText,
                    base64audio: base64,
                    auto_judge: true
                })
            });
    
            createPreview(blob, materialId, recognizedText);
        };
    }
    
    function stopRecording() {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
    }
    
    function playNext() {
        if (currentIndex >= materials.length) {
            if (confirm("å¬å†™å®Œæˆï¼Œç¡®å®šæäº¤å—ï¼Ÿç‚¹å‡»å–æ¶ˆé‡å¬ä¸€æ¬¡ã€‚")) {
                localStorage.setItem('practice_answers', JSON.stringify(answers));
                window.location.href = "{% url 'review_page' %}";
            } else {
                currentIndex = 0;
                answers = [];
                previewArea.innerHTML = '';
                shuffle(materials);
                playNext();
            }
            return;
        }
    
        const material = materials[currentIndex];
        const question = material.questions[0];
    
        let audioDuration = 3;
    
        if (question && question.question_audio) {
            questionAudioEl.src = question.question_audio;
            questionAudioEl.onloadedmetadata = function() {
                audioDuration = questionAudioEl.duration;
                questionAudioEl.play();
                setTimeout(playNext, audioDuration * 2000);
            };
        } else if (question) {
            questionTextEl.textContent = question.question_text;
            const utterance = new SpeechSynthesisUtterance(question.question_text);
            utterance.lang = 'ja-JP';
            speechSynthesis.speak(utterance);
            audioDuration = Math.max(question.question_text.length * 0.2, 3);
            setTimeout(playNext, audioDuration * 2000);
        } else {
            questionTextEl.textContent = "(æ— é¢˜ç›®)";
            setTimeout(playNext, audioDuration * 2000);
        }
    
        currentIndex++;
    }
    
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
    }
    
    function blobToBase64(blob) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(blob);
        });
    }
    
    function createPreview(blob, id, text) {
        const div = document.createElement('div');
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = URL.createObjectURL(blob);
        const p = document.createElement('p');
        p.textContent = `è¯†åˆ«ï¼š${text}`;
        div.append(audio, p);
        previewArea.appendChild(div);
    }
    
    async function transcribeBlob(blob) {
        return new Promise(resolve => {
            if (!window.webkitSpeechRecognition) {
                resolve('');
                return;
            }
            const rec = new webkitSpeechRecognition();
            rec.lang = 'ja-JP';
            rec.onresult = e => resolve(e.results[0][0].transcript);
            rec.onerror = () => resolve('');
            rec.start();
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            const cookies = document.cookie.split(';');
            for (const c of cookies) {
                const cookie = c.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    checkMicrophoneAvailability();
    playNext();
    </script>    
<script>
    function checkMic() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge ç­‰ç°ä»£æµè§ˆå™¨ã€‚");
            return;
        }
    
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                alert("âœ… éº¦å…‹é£å¯ç”¨ï¼Œå¯ä»¥å¼€å§‹å½•éŸ³ç»ƒä¹ ï¼");
                stream.getTracks().forEach(track => track.stop());
            })
            .catch(error => {
                alert("âš ï¸ éº¦å…‹é£ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å¹¶æˆæƒï¼");
                console.warn("éº¦å…‹é£æ£€æµ‹å¤±è´¥ï¼š", error);
            });
    }
    
    // âœ… é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ URL å‚æ•°ï¼Œè‡ªåŠ¨æ£€æµ‹éº¦å…‹é£
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("checkmic") === "1") {
        checkMic();
    }
    </script>
</body>
</html>